icon: https://apps.okteto.com/movies/icon.png

build:
  api:
    context: api
  frontend:
    context: frontend
  catalog:
    context: catalog
  rent:
    context: rentals/rent
  worker:
    context: rentals/worker
  tests:
    context: tests

deploy:
  - name: Deploy Frontend
    command: helm upgrade --install frontend frontend/chart --set image=${OKTETO_BUILD_FRONTEND_IMAGE}
  - name: Deploy Catalog
    command: helm upgrade --install catalog catalog/chart --set image=${OKTETO_BUILD_CATALOG_IMAGE}
  - name: Deploy Rentals
    command: helm upgrade --install rentals rentals/chart --set api.image=${OKTETO_BUILD_RENT_IMAGE} --set worker.image=${OKTETO_BUILD_WORKER_IMAGE}
  - name: Deploy API
    command: helm upgrade --install api api/chart --set image=${OKTETO_BUILD_API_IMAGE}

dev:
  api:
    image: okteto/golang:1.24
    workdir: /usr/src/app
    command: bash
    securityContext:
      capabilities:
        add:
        - SYS_PTRACE
    sync:
      - api:/usr/src/app
    forward:
      - 2346:2345
  
  frontend:
    image: okteto/node:20
    workdir: /usr/src/app
    command: bash
    sync:
      - frontend:/usr/src/app

  catalog:
    command: bash
    sync:
      - catalog:/src
    forward:
      - 9229:9229

  rent:
    command: mvn spring-boot:run
    workdir: /app
    sync:
      - rentals/rent:/app
    volumes:
      - /root/.m2
    forward:
      - 5005:5005
      - 5432:postgresql:5432
      
  worker:
    image: okteto/golang:1.24
    workdir: /usr/src/app
    command: bash
    securityContext:
      capabilities:
        add:
        - SYS_PTRACE
    sync:
      - rentals/worker:/usr/src/app
    forward:
      - 2345:2345
test:
  e2e:
    image: ${OKTETO_BUILD_TESTS_IMAGE}
    context: tests
    caches:
      - yarn/.cache
      - node_modules
    commands:
      - yarn install
      - yarn test
    artifacts:
      - test-results
      - playwright-report
